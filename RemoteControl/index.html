<html>
    <head>
        <title>Internet Spaceships!</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript"></script>
        <style type="text/css">
            body, html, head, div, img {
                margin: 0px;
                padding: 0px;
            }
            body {
                overflow: hidden;
            }
        </style>
    </head>
    <body>
        <canvas id="viewport">
            Sorry, EVE Remote Control requires a browser with support for HTML5 Canvas.
        </canvas>
        <canvas id="backbuffer" style="display: none">
        </canvas>
        <script type="text/javascript">
            var counter = 0;
            var updateInProgress = false;
            
            function updateViewport (pixels, indices) {
                var vp = document.getElementById("viewport");
                var vpc = vp.getContext("2d");
                var bb = document.getElementById("backbuffer");
                var bbc = bb.getContext("2d");
            
                var blockSize = 16;
                var srcWidth = indices[0]["x"];
                var srcHeight = indices[0]["y"];
                var dstWidth = window.innerWidth;
                var dstHeight = window.innerHeight;
                var ratio = Math.min(
                    dstWidth / srcWidth, dstHeight / srcHeight
                );
                var floor = Math.floor;
                
                dstWidth = floor(srcWidth * ratio);
                dstHeight = floor(srcHeight * ratio);
                
                if (indices.length == 1) {
                    // Keyframe
                    if ((bb.width != srcWidth) || (bb.height != srcHeight)) {
                        bb.width = srcWidth;
                        bb.height = srcHeight;
                    }
                    bbc.drawImage(pixels, 0, 0, srcWidth, srcHeight);
                } else if (indices.length > 1) {
                    // Deltas
                    var l = indices.length;
                    for (var i = 1; i < l; i++) {
                        var idx = indices[i];
                        bbc.drawImage(
                            pixels, (i - 1) * blockSize, 0, blockSize, blockSize, 
                            idx["x"], idx["y"], blockSize, blockSize
                        );
                    }
                }
                
                if ((vp.width != dstWidth) || (vp.height != dstHeight)) {
                    vp.width = dstWidth;
                    vp.height = dstHeight;
                }
                vpc.drawImage(
                    bb, 0, 0, srcWidth, srcHeight,
                    0, 0, dstWidth, dstHeight
                );
                
                updateInProgress = false;
            }
            
            function refreshImage () {
                if (updateInProgress)
                    return;
            
                var error = "error";
                var data = {
                    "deltas": null,
                    "indices": null
                };
                var newDeltas = document.createElement("img");
                
                var sync = function () {
                    if ((data.deltas == null) || (data.indices == null))
                        return;
                
                    var succeeded = (data.deltas != error) &&
                        (data.indices != error);
                    
                    if (succeeded) {
                        if (updateInProgress)
                            window.setTimeout(sync, 1);
                        else {
                            updateInProgress = true;
                            window.setTimeout(refreshImage, 33);
                            updateViewport(data.deltas, data.indices);
                        }
                    } else
                        window.setTimeout(refreshImage, 1000);
                };
                
                counter += 1;
                
                newDeltas.addEventListener("load", function () {
                    data.deltas = newDeltas;
                    sync();
                }, true);
                newDeltas.addEventListener("error", function () {
                    data.deltas = error;
                    sync();
                }, true);
                
                newDeltas.setAttribute("src", "/eve/viewport/deltas?i=" + counter);
                $.getJSON(
                    "/eve/viewport/indices",
                    {"i": counter},
                    function (result, status, xhr) {
                        data.indices = result;
                        sync();
                    }
                );
            }

            $("#viewport").ready(refreshImage);
        </script>
    </body>
</html>