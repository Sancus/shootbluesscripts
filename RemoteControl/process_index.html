<html>
    <head>
        <title>EVE Remote Control</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js" type="text/javascript"></script>
        <style type="text/css">
            body, html, head, div, img {
                margin: 0px;
                padding: 0px;
            }
            body {
                overflow: hidden;
            }
        </style>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    </head>
    <body>
        <canvas id="viewport">
            Sorry, EVE Remote Control requires a browser with support for HTML5 Canvas.
        </canvas>
        <canvas id="backbuffer" style="display: none">
        </canvas>
        <script type="text/javascript">
            var counter = 0;
            var updateInProgress = false;
            var eventQueue = [];
            var eventInProgress = false;
            var scaleRatio = 1.0;
            
            function updateViewport (pixels, indices) {
                var vp = document.getElementById("viewport");
                var vpc = vp.getContext("2d");
                var bb = document.getElementById("backbuffer");
                var bbc = bb.getContext("2d");
            
                var blockSize = 16;
                var srcWidth = indices[0]["x"];
                var srcHeight = indices[0]["y"];
                var dstWidth = window.innerWidth;
                var dstHeight = window.innerHeight;
                scaleRatio = Math.min(
                    dstWidth / srcWidth, dstHeight / srcHeight
                );
                var floor = Math.floor;
                
                dstWidth = floor(srcWidth * scaleRatio);
                dstHeight = floor(srcHeight * scaleRatio);
                
                if (indices.length == 1) {
                    // Keyframe
                    if ((bb.width != srcWidth) || (bb.height != srcHeight)) {
                        bb.width = srcWidth;
                        bb.height = srcHeight;
                    }
                    bbc.drawImage(pixels, 0, 0, srcWidth, srcHeight);
                } else if (indices.length > 1) {
                    // Deltas
                    var l = indices.length;
                    for (var i = 1; i < l; i++) {
                        var idx = indices[i];
                        bbc.drawImage(
                            pixels, (i - 1) * blockSize, 0, blockSize, blockSize, 
                            idx["x"], idx["y"], blockSize, blockSize
                        );
                    }
                }
                
                if ((vp.width != dstWidth) || (vp.height != dstHeight)) {
                    vp.width = dstWidth;
                    vp.height = dstHeight;
                }
                vpc.drawImage(
                    bb, 0, 0, srcWidth, srcHeight,
                    0, 0, dstWidth, dstHeight
                );
                
                updateInProgress = false;
            }
            
            function refreshImage () {
                if (updateInProgress)
                    return;
            
                var error = "error";
                var data = {
                    "deltas": null,
                    "indices": null
                };
                var newDeltas = document.createElement("img");
                
                var sync = function () {
                    if ((data.deltas == null) || (data.indices == null))
                        return;
                
                    var succeeded = (data.deltas != error) &&
                        (data.indices != error);
                    
                    if (succeeded) {
                        if (updateInProgress)
                            window.setTimeout(sync, 1);
                        else {
                            updateInProgress = true;
                            window.setTimeout(refreshImage, 33);
                            updateViewport(data.deltas, data.indices);
                        }
                    } else
                        window.setTimeout(refreshImage, 1000);
                };
                
                counter += 1;
                
                newDeltas.addEventListener("load", function () {
                    data.deltas = newDeltas;
                    sync();
                }, true);
                newDeltas.addEventListener("error", function () {
                    data.deltas = error;
                    sync();
                }, true);
                
                newDeltas.setAttribute("src", "viewport/deltas?i=" + counter);
                $.getJSON(
                    "viewport/indices",
                    {"i": counter},
                    function (result, status, xhr) {
                        data.indices = result;
                        sync();
                    }
                );
            }
            
            function sendEvent (eventType, payload, enqueue) {
                if (eventInProgress) {
                    if (enqueue)
                        eventQueue.push({
                            "type": eventType,
                            "payload": payload
                        });
                    
                    return;
                }
                eventInProgress = true;
                
                var callback = function (data) {
                    eventInProgress = false;
                    if (eventQueue.length > 0) {
                        var evt = eventQueue[0];
                        eventQueue.splice(0, 1);
                        sendEvent(evt.type, evt.payload);
                    }
                };
                
                $.ajax({
                    type: "POST",
                    url: "event/" + eventType, 
                    data: payload,
                    dataType: "json",
                    success: callback,
                    error: callback
                });
            }
            
            function getMouseArgs (evt) {
                var result = {
                    "x": Math.floor(evt.pageX / scaleRatio),
                    "y": Math.floor(evt.pageY / scaleRatio)
                };
                if ((evt.which >= 1) && (evt.which <= 3)) {
                    var buttonNames = ["Left", "Middle", "Right"];
                    result.button = buttonNames[evt.which - 1];
                }
                return result;
            }
            
            function onMouseDown (evt) {
                evt.preventDefault();
                var args = getMouseArgs(evt);
                sendEvent("mousedown", args);
            }
            
            function onMouseMove (evt) {
                evt.preventDefault();
                var args = getMouseArgs(evt);
                sendEvent("mousemove", args);
            }
            
            function onMouseUp (evt) {
                evt.preventDefault();
                var args = getMouseArgs(evt);
                sendEvent("mouseup", args);
            }
            
            function onContextMenu (evt) {
                evt.preventDefault();
                return false;
            }
            
            function onKeyDown (evt) {
                if ((evt.which == 13) || (evt.which == 10) || (evt.which == 8) || (evt.which == 9) || (evt.which == 27)) {
                    evt.preventDefault();
                    onKeyPress(evt);
                }
            }
            
            function onKeyUp (evt) {
                if ((evt.which == 13) || (evt.which == 10) || (evt.which == 8) || (evt.which == 9) || (evt.which == 27))
                    evt.preventDefault();
            }
            
            function onKeyPress (evt) {
                var args = {
                    "char": evt.which
                };
                sendEvent("keypress", args);
                evt.preventDefault();
            }
            
            function initialize () {
                var vp = $("#viewport");
                vp.bind("mousedown", onMouseDown);
                vp.bind("mousemove", onMouseMove);
                vp.bind("mouseup", onMouseUp);
                vp.bind("contextmenu", onContextMenu);
                $(document).bind("keydown", onKeyDown);
                $(document).bind("keyup", onKeyUp);
                $(document).bind("keypress", onKeyPress);
                refreshImage();
            }

            $("#viewport").ready(initialize);
        </script>
    </body>
</html>